// @version=5
strategy("ATR Channel Strategy", overlay=true, initial_capital=10000, default_qty_value=10000, default_qty_type=strategy.cash, commission_type=strategy.commission.percent, commission_value=0.01)

// 参数设置
emaLength = input.int(14, "EMA长度", minval=1)
minTrendLength = input.int(2, "趋势最小长度", minval=2, tooltip="连续多少根K线确认为趋势")

// 计算EMA
emaValue = ta.ema(close, emaLength)

// 判断K线位置
isAboveEma = open > emaValue and close > emaValue
isBelowEma = open < emaValue and close < emaValue
isCrossingEma = not isAboveEma and not isBelowEma

// 存储状态：1=上方，-1=下方，0=横穿
var int candleState = 0
if isAboveEma
    candleState := 1
else if isBelowEma
    candleState := -1
else
    candleState := 0

// 跟踪连续状态计数
var int uptrendCount = 0
var int downtrendCount = 0

// 更新连续状态计数
if candleState == 1
    uptrendCount := uptrendCount + 1
    downtrendCount := 0
else if candleState == -1
    downtrendCount := downtrendCount + 1
    uptrendCount := 0
else
    uptrendCount := 0
    downtrendCount := 0

// 确定当前趋势类型
var string currentTrend = "oscillation" // 默认为震荡趋势
var string previousTrend = "oscillation" // 记录上一个趋势

// 保存上一个趋势
previousTrend := currentTrend

// 更新当前趋势
if uptrendCount >= minTrendLength
    currentTrend := "uptrend"
else if downtrendCount >= minTrendLength
    currentTrend := "downtrend"
else
    // 检查前一根和当前根是否构成趋势
    bool isConsistentUptrend = candleState == 1 and candleState[1] == 1
    bool isConsistentDowntrend = candleState == -1 and candleState[1] == -1
    
    if isConsistentUptrend
        currentTrend := "uptrend"
    else if isConsistentDowntrend
        currentTrend := "downtrend"
    else
        currentTrend := "oscillation"

// 趋势变化检测
bool trendChanged = currentTrend != previousTrend
bool uptrendStarted = trendChanged and currentTrend == "uptrend"
bool downtrendStarted = trendChanged and currentTrend == "downtrend"
bool uptrendEnded = trendChanged and previousTrend == "uptrend"
bool downtrendEnded = trendChanged and previousTrend == "downtrend"

// 交易信号
if (uptrendStarted)
    strategy.entry("多单", strategy.long, comment="上升趋势开始")
    
if (downtrendStarted)
    strategy.entry("空单", strategy.short, comment="下降趋势开始")
    
if (uptrendEnded or downtrendEnded)
    strategy.close_all(comment="趋势结束平仓")

// 绘制背景
bgcolor(currentTrend == "uptrend" ? color.new(color.green, 90) :
       currentTrend == "downtrend" ? color.new(color.red, 90) :
       color.new(color.yellow, 90))

// 绘制EMA线
plot(emaValue, "EMA14", color.blue, 1)

// 绘制交易点位
plotshape(series=uptrendStarted, title="做多信号", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(series=downtrendStarted, title="做空信号", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)
plotshape(series=uptrendEnded or downtrendEnded, title="平仓信号", location=location.belowbar, color=color.blue, style=shape.circle, size=size.tiny)